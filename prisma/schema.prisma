generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CLIENT MANAGEMENT
// ============================================================================

model clients {
  id            Int      @id @default(autoincrement())
  company_name  String   @unique
  tipo_cliente  String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  client_contacts client_contacts[]
}

model client_contacts {
  id          Int      @id @default(autoincrement())
  client_id   Int
  nombre      String
  apellido    String
  email       String
  telefono    String?
  cargo       String?
  es_principal Boolean  @default(true)
  activo      Boolean  @default(true)
  notas       String?
  created_by  Int?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  client              clients                    @relation(fields: [client_id], references: [id], onDelete: Cascade)
  distribution_lists  distribution_list_contacts[]

  @@unique([client_id, email])
  @@index([email])
  @@index([activo])
}

// ============================================================================
// DISTRIBUTION LISTS & NEWSLETTER
// ============================================================================

enum tipo_distribution_list {
  INSTITUCIONAL
  SECTOR
  PROYECTO
  PROSPECTO
  CUSTOM

  @@map("tipo_distribution_list")
}

model distribution_lists {
  id          String                  @id @default(uuid()) @db.Uuid
  name        String                  @unique
  tipo        tipo_distribution_list  @default(PROSPECTO)
  description String?
  activa      Boolean                 @default(true)
  created_by  Int?
  created_at  DateTime                @default(now())
  updated_at  DateTime                @updatedAt

  // Relations
  contacts distribution_list_contacts[]
}

model distribution_list_contacts {
  id         String   @id @default(uuid()) @db.Uuid
  list_id    String   @db.Uuid
  contact_id Int
  added_by   Int?
  added_at   DateTime @default(now())
  notas      String?

  // Relations
  list    distribution_lists @relation(fields: [list_id], references: [id], onDelete: Cascade)
  contact client_contacts    @relation(fields: [contact_id], references: [id], onDelete: Cascade)

  @@unique([list_id, contact_id])
  @@index([list_id])
  @@index([contact_id])
}

// ============================================================================
// NEWSLETTER QUEUE SYSTEM
// ============================================================================

model newsletter_queue {
  id              String   @id @default(uuid()) @db.Uuid
  subject         String
  html_content    String
  text_content    String?
  list_ids        String[] @db.Uuid
  status          String   @default("pending") // pending, processing, completed, error
  total_recipients Int     @default(0)
  sent_count      Int      @default(0)
  failed_count    Int      @default(0)
  retry_count     Int      @default(0)
  max_retries     Int      @default(3)
  error_message   String?
  scheduled_at    DateTime?
  started_at      DateTime?
  completed_at    DateTime?
  created_by      Int?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Stages support
  campaign_id     String?  @db.Uuid
  stage_number    Int      @default(1)
  total_stages    Int      @default(1)
  stage_size      Int      @default(0)

  @@index([status])
  @@index([created_at])
  @@index([campaign_id])
  @@index([scheduled_at, status])
}

// ============================================================================
// WORKER SESSION TRACKING
// ============================================================================

model worker_sessions {
  id                  String    @id @default(uuid()) @db.Uuid
  instance_id         String    @unique  // hostname-pid-timestamp
  hostname            String
  pid                 Int
  status              String    @default("starting")  // starting, running, stopping, stopped, crashed
  current_job_id      String?   @db.Uuid
  current_job_subject String?
  started_at          DateTime  @default(now())
  last_heartbeat_at   DateTime  @default(now())
  stopped_at          DateTime?
  jobs_processed      Int       @default(0)
  jobs_failed         Int       @default(0)
  metadata            Json?     // version, config, environment info, etc.

  @@index([status, last_heartbeat_at])
  @@index([hostname])
}
